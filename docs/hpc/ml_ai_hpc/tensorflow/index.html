<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-hpc/ml_ai_hpc/tensorflow" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">TensorFlow | Connecting researchers to computational resources.</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://services.rt.nyu.edu/img/NYU.svg"><meta data-rh="true" name="twitter:image" content="https://services.rt.nyu.edu/img/NYU.svg"><meta data-rh="true" property="og:url" content="https://services.rt.nyu.edu/docs/hpc/ml_ai_hpc/tensorflow/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="TensorFlow | Connecting researchers to computational resources."><meta data-rh="true" name="description" content="This was adapted from Princeton University Multi-GPU Training with PyTorch"><meta data-rh="true" property="og:description" content="This was adapted from Princeton University Multi-GPU Training with PyTorch"><link data-rh="true" rel="icon" href="/img/NYU.ico"><link data-rh="true" rel="canonical" href="https://services.rt.nyu.edu/docs/hpc/ml_ai_hpc/tensorflow/"><link data-rh="true" rel="alternate" href="https://services.rt.nyu.edu/docs/hpc/ml_ai_hpc/tensorflow/" hreflang="en"><link data-rh="true" rel="alternate" href="https://services.rt.nyu.edu/docs/hpc/ml_ai_hpc/tensorflow/" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"TensorFlow","item":"https://services.rt.nyu.edu/docs/hpc/ml_ai_hpc/tensorflow"}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Connecting researchers to computational resources. RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Connecting researchers to computational resources. Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-2DXB3BDH70"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-2DXB3BDH70",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.f829a653.css">
<script src="/assets/js/runtime~main.1423adea.js" defer="defer"></script>
<script src="/assets/js/main.1b6e9861.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||"light"),document.documentElement.setAttribute("data-theme-choice",t||"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/NYU.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_TUNJ" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/NYU.svg" alt="NYU torch logo" class="themedComponent_adik themedComponent--light_G91j"><img src="/img/NYU.svg" alt="NYU torch logo" class="themedComponent_adik themedComponent--dark_ZN7y"></div><b class="navbar__title text--truncate">Research Technology Services</b></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/genai/getting_started/intro/">Pythia</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/hpc/getting_started/intro/">HPC</a><a class="navbar__item navbar__link" href="/docs/cloud/getting_started/intro/">Cloud</a><a class="navbar__item navbar__link" href="/docs/srde/getting_started/intro/">SRDE</a><a href="https://hsrn.nyu.edu/docs/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">HSRN<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_NVDT"><use href="#theme-svg-external-link"></use></svg></a><a class="navbar__item navbar__link" href="/blog/">Announcements</a><div class="toggle_jqKN colorModeToggle_gY5u"><button class="clean-btn toggleButton_lieL toggleButtonDisabled_sjb2" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_AmaU lightToggleIcon_PUFc"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_AmaU darkToggleIcon_woI4"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_AmaU systemToggleIcon_QZRn"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_gKxF"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input id="search_input_react" type="search" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_necp"><div class="docsWrapper_wAz_"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_QBOB" type="button"></button><div class="docRoot_gn_g"><aside class="theme-doc-sidebar-container docSidebarContainer_RCWh"><div class="sidebarViewport_BocM"><div class="sidebar_w3s6"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_EeVB"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_HmkA menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/hpc/getting_started/intro/"><span title="Getting Started" class="categoryLinkLabel_vKI6">Getting Started</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_HmkA menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/hpc/connecting_to_hpc/connecting_to_hpc/"><span title="Setup" class="categoryLinkLabel_vKI6">Setup</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_HmkA menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/hpc/storage/intro_and_data_management/"><span title="Storage &amp; Data transfers" class="categoryLinkLabel_vKI6">Storage &amp; Data transfers</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_HmkA menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/hpc/datasets/intro/"><span title="Datasets" class="categoryLinkLabel_vKI6">Datasets</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_HmkA menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/hpc/submitting_jobs/slurm_submitting_jobs/"><span title="Submitting jobs" class="categoryLinkLabel_vKI6">Submitting jobs</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_HmkA menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/hpc/tools_and_software/intro/"><span title="Tools &amp; Software" class="categoryLinkLabel_vKI6">Tools &amp; Software</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_HmkA menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/hpc/containers/intro/"><span title="Containers" class="categoryLinkLabel_vKI6">Containers</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_HmkA menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/hpc/ml_ai_hpc/intro/"><span title="ML/AI on HPC" class="categoryLinkLabel_vKI6">ML/AI on HPC</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/hpc/ml_ai_hpc/intro/"><span title="Machine Learning (ML) and Artificial Intelligence (AI) on HPC" class="linkLabel_BOGb">Machine Learning (ML) and Artificial Intelligence (AI) on HPC</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/hpc/ml_ai_hpc/pytorch_intro/"><span title="Single-GPU Training with PyTorch" class="linkLabel_BOGb">Single-GPU Training with PyTorch</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/hpc/ml_ai_hpc/pytorch_dpp/"><span title="Multi-GPU Training with PyTorch: Distributed Data Parallel (DDP)" class="linkLabel_BOGb">Multi-GPU Training with PyTorch: Distributed Data Parallel (DDP)</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/hpc/ml_ai_hpc/tensorflow/"><span title="TensorFlow" class="linkLabel_BOGb">TensorFlow</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/hpc/ml_ai_hpc/llm_fine_tuning/"><span title="Fine tune LLMs on HPC" class="linkLabel_BOGb">Fine tune LLMs on HPC</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_HmkA menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/hpc/ml_ai_hpc/LLM Inference/run_hf_model/"><span title="LLM Inference" class="categoryLinkLabel_vKI6">LLM Inference</span></a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_HmkA menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/hpc/ood/ood_intro/"><span title="Open OnDemand (OOD)" class="categoryLinkLabel_vKI6">Open OnDemand (OOD)</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/hpc/spec_sheet/"><span title="Torch Spec Sheet" class="linkLabel_BOGb">Torch Spec Sheet</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/hpc/system_status/"><span title="Greene System Status" class="linkLabel_BOGb">Greene System Status</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_HmkA menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/hpc/tutorial_intro_shell_hpc/intro/"><span title="Tutorial: Intro to Shell for HPC" class="categoryLinkLabel_vKI6">Tutorial: Intro to Shell for HPC</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_HmkA menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/hpc/tutorial_intro_hpc/intro_hpc/"><span title="Tutorial: Intro to HPC" class="categoryLinkLabel_vKI6">Tutorial: Intro to HPC</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_HmkA menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/hpc/support/support/"><span title="Support" class="categoryLinkLabel_vKI6">Support</span></a></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_M8Os"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_dZwW"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_cg7U"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_l9oI"><div class="docItemContainer_ENRc"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_N0Nx" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_CnUo"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">ML/AI on HPC</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">TensorFlow</span></li></ul></nav><div class="tocCollapsible_lcDd theme-doc-toc-mobile tocMobile_o_ql"><button type="button" class="clean-btn tocCollapsibleButton_A397">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>TensorFlow</h1></header>
<div class="theme-admonition theme-admonition-info admonition_nT0D alert alert--info"><div class="admonitionHeading_v1P0"><span class="admonitionIcon_Vpqq"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_kdNk"><p>This was adapted from <a href="https://github.com/PrincetonUniversity/multi_gpu_training" target="_blank" rel="noopener noreferrer" class="">Princeton University Multi-GPU Training with PyTorch</a></p></div></div>
<p>The starting point for <a href="https://www.tensorflow.org/tutorials/distribute/keras" target="_blank" rel="noopener noreferrer" class="">multi-GPU training with Keras</a> is <code>tf.distribute.MirroredStrategy</code>. In this approach, the model is copied to <code>N</code> GPUs and gradients are synced as we saw previously. Be sure to use <a href="https://www.tensorflow.org/api_docs/python/tf/data" target="_blank" rel="noopener noreferrer" class=""><code>tf.data</code></a> to handle data loading as is done in the example on this page and is explained graphically <a href="https://colab.research.google.com/github/tensorflow/docs/blob/master/site/en/guide/data_performance.ipynb#scrollTo=i3NtGI3r-jLp" target="_blank" rel="noopener noreferrer" class="">here</a>.</p>
<h2 class="anchor anchorTargetStickyNavbar_wKjT" id="single-node-synchronous-multi-gpu-training">Single-Node, Synchronous, Multi-GPU Training<a href="#single-node-synchronous-multi-gpu-training" class="hash-link" aria-label="Direct link to Single-Node, Synchronous, Multi-GPU Training" title="Direct link to Single-Node, Synchronous, Multi-GPU Training" translate="no">​</a></h2>
<p>Here were train the ResNet-50 model on the Cassava dataset (see <a href="https://www.youtube.com/watch?v=xzSCvXDcX68" target="_blank" rel="noopener noreferrer" class="">video</a> on TensorFlow YouTube channel). Here is another example <a href="https://www.youtube.com/watch?v=HCLmM1PyDIs" target="_blank" rel="noopener noreferrer" class="">video</a> using the &quot;cats vs. dog&quot; dataset.</p>
<h3 class="anchor anchorTargetStickyNavbar_wKjT" id="step-1-create-a-tensorflow-overlay-file">Step 1: Create a TensorFlow Overlay File<a href="#step-1-create-a-tensorflow-overlay-file" class="hash-link" aria-label="Direct link to Step 1: Create a TensorFlow Overlay File" title="Direct link to Step 1: Create a TensorFlow Overlay File" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_ndbq theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_Zo7j"><pre tabindex="0" class="prism-code language-bash codeBlock_hgHP thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_EpfB"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token comment" style="color:hsl(230, 4%, 64%)"># create a working directory</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token plain">NetID@log-1 ~</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token plain">$ </span><span class="token function" style="color:hsl(221, 87%, 60%)">mkdir</span><span class="token plain"> /scratch/</span><span class="token operator" style="color:hsl(221, 87%, 60%)">&lt;</span><span class="token plain">NetID</span><span class="token operator" style="color:hsl(221, 87%, 60%)">&gt;</span><span class="token plain">/tensorflow-example</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token plain">NetID@log-1 ~</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token plain">$ </span><span class="token builtin class-name" style="color:hsl(35, 99%, 36%)">cd</span><span class="token plain"> /scratch/</span><span class="token operator" style="color:hsl(221, 87%, 60%)">&lt;</span><span class="token plain">NetID</span><span class="token operator" style="color:hsl(221, 87%, 60%)">&gt;</span><span class="token plain">/tensorflow-example</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)"># copy over an overlay file with sufficient resources and unzip it</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token plain">NetID@cm001 tensorflow-example</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token plain">$ </span><span class="token function" style="color:hsl(221, 87%, 60%)">cp</span><span class="token plain"> </span><span class="token parameter variable" style="color:hsl(221, 87%, 60%)">-rp</span><span class="token plain"> /scratch/work/public/overlay-fs-ext3/overlay-15GB-500K.ext3.gz </span><span class="token builtin class-name" style="color:hsl(35, 99%, 36%)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token plain">NetID@cm001 tensorflow-example</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token plain">$ gunzip overlay-15GB-500K.ext3.gz</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)"># start the singularity environment</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token plain">NetID@cm001 tensorflow-example</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token plain">$ singularity </span><span class="token builtin class-name" style="color:hsl(35, 99%, 36%)">exec</span><span class="token plain"> </span><span class="token parameter variable" style="color:hsl(221, 87%, 60%)">--overlay</span><span class="token plain"> overlay-15GB-500K.ext3:rw /scratch/work/public/singularity/cuda12.1.1-cudnn8.9.0-devel-ubuntu22.04.2.sif /bin/bash</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)"># install miniforge in singularity environment</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">Singularity</span><span class="token operator" style="color:hsl(221, 87%, 60%)">&gt;</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">wget</span><span class="token plain"> --no-check-certificate https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-x86_64.sh</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">Singularity</span><span class="token operator" style="color:hsl(221, 87%, 60%)">&gt;</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">bash</span><span class="token plain"> Miniforge3-Linux-x86_64.sh </span><span class="token parameter variable" style="color:hsl(221, 87%, 60%)">-b</span><span class="token plain"> </span><span class="token parameter variable" style="color:hsl(221, 87%, 60%)">-p</span><span class="token plain"> /ext3/miniforge3</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)"># create an miniconda environment file </span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">Singularity</span><span class="token operator" style="color:hsl(221, 87%, 60%)">&gt;</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">touch</span><span class="token plain"> /ext3/env.sh</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">Singularity</span><span class="token operator" style="color:hsl(221, 87%, 60%)">&gt;</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">nano</span><span class="token plain"> /ext3/env.sh</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)"># and add the following content to it:</span><br></span></code></pre></div></div>
<div class="language-bash codeBlockContainer_ndbq theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_Zo7j"><pre tabindex="0" class="prism-code language-bash codeBlock_hgHP thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_EpfB"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token shebang important" style="color:hsl(230, 8%, 24%);font-weight:bold">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token builtin class-name" style="color:hsl(35, 99%, 36%)">unset</span><span class="token plain"> </span><span class="token parameter variable" style="color:hsl(221, 87%, 60%)">-f</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">which</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token builtin class-name" style="color:hsl(35, 99%, 36%)">source</span><span class="token plain"> /ext3/miniforge3/etc/profile.d/conda.sh</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token builtin class-name" style="color:hsl(35, 99%, 36%)">export</span><span class="token plain"> </span><span class="token assign-left variable environment constant" style="color:hsl(35, 99%, 36%)">PATH</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain">/ext3/miniforge3/bin:</span><span class="token environment constant" style="color:hsl(35, 99%, 36%)">$PATH</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token builtin class-name" style="color:hsl(35, 99%, 36%)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:hsl(221, 87%, 60%)">PYTHONPATH</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain">/ext3/miniforge3/bin:</span><span class="token environment constant" style="color:hsl(35, 99%, 36%)">$PATH</span><br></span></code></pre></div></div>
<div class="language-bash codeBlockContainer_ndbq theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_Zo7j"><pre tabindex="0" class="prism-code language-bash codeBlock_hgHP thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_EpfB"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token comment" style="color:hsl(230, 4%, 64%)"># activate the new environment and initialize</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">Singularity</span><span class="token operator" style="color:hsl(221, 87%, 60%)">&gt;</span><span class="token plain"> </span><span class="token builtin class-name" style="color:hsl(35, 99%, 36%)">source</span><span class="token plain"> /ext3/env.sh </span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">Singularity</span><span class="token operator" style="color:hsl(221, 87%, 60%)">&gt;</span><span class="token plain"> conda config </span><span class="token parameter variable" style="color:hsl(221, 87%, 60%)">--remove</span><span class="token plain"> channels defaults</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">Singularity</span><span class="token operator" style="color:hsl(221, 87%, 60%)">&gt;</span><span class="token plain"> conda clean </span><span class="token parameter variable" style="color:hsl(221, 87%, 60%)">--all</span><span class="token plain"> </span><span class="token parameter variable" style="color:hsl(221, 87%, 60%)">--yes</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">Singularity</span><span class="token operator" style="color:hsl(221, 87%, 60%)">&gt;</span><span class="token plain"> conda update </span><span class="token parameter variable" style="color:hsl(221, 87%, 60%)">-n</span><span class="token plain"> base conda </span><span class="token parameter variable" style="color:hsl(221, 87%, 60%)">-y</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">Singularity</span><span class="token operator" style="color:hsl(221, 87%, 60%)">&gt;</span><span class="token plain"> conda </span><span class="token function" style="color:hsl(221, 87%, 60%)">install</span><span class="token plain"> pip </span><span class="token parameter variable" style="color:hsl(221, 87%, 60%)">-y</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">Singularity</span><span class="token operator" style="color:hsl(221, 87%, 60%)">&gt;</span><span class="token plain"> conda </span><span class="token function" style="color:hsl(221, 87%, 60%)">install</span><span class="token plain"> ipykernel </span><span class="token parameter variable" style="color:hsl(221, 87%, 60%)">-y</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)"># check that you&#x27;re using the miniconda environment</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)"># you should get the following output</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">Singularity</span><span class="token operator" style="color:hsl(221, 87%, 60%)">&gt;</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">which</span><span class="token plain"> conda</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">/ext3/miniforge3/bin/conda</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">Singularity</span><span class="token operator" style="color:hsl(221, 87%, 60%)">&gt;</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">which</span><span class="token plain"> python</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">/ext3/miniforge3/bin/python</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">Singularity</span><span class="token operator" style="color:hsl(221, 87%, 60%)">&gt;</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">which</span><span class="token plain"> pip</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">/ext3/miniforge3/bin/pip</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)"># install TensorFlow</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">Singularity</span><span class="token operator" style="color:hsl(221, 87%, 60%)">&gt;</span><span class="token plain"> pip </span><span class="token function" style="color:hsl(221, 87%, 60%)">install</span><span class="token plain"> tensorflow</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token plain">and-cuda</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token plain"> tensorflow_datasets</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_wKjT" id="step-2-download-the-data">Step 2: Download the Data<a href="#step-2-download-the-data" class="hash-link" aria-label="Direct link to Step 2: Download the Data" title="Direct link to Step 2: Download the Data" translate="no">​</a></h3>
<p>This example using the <code>cassava</code> dataset which requires 4 GB of storage space. Be sure to save this in your <code>/scratch</code> space and not in <code>/home</code>.</p>
<p>Please save the following into a file named <code>download_data_and_weights.py</code>:</p>
<div class="language-python codeBlockContainer_ndbq theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_Zo7j"><pre tabindex="0" class="prism-code language-python codeBlock_hgHP thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_EpfB"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token keyword" style="color:hsl(301, 63%, 40%)">import</span><span class="token plain"> tensorflow </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">as</span><span class="token plain"> tf</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">import</span><span class="token plain"> tensorflow_datasets </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">as</span><span class="token plain"> tfds</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)"># download the data (4 GB) on the login node</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">_ </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> tfds</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">load</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">name</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;cassava&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> with_info</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token boolean" style="color:hsl(35, 99%, 36%)">True</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> as_supervised</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token boolean" style="color:hsl(35, 99%, 36%)">True</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> data_dir</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;.&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)"># download the model weights on the login node</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">_ </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> tf</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">keras</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">applications</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">ResNet50</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">weights</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;imagenet&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> include_top</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token boolean" style="color:hsl(35, 99%, 36%)">False</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><br></span></code></pre></div></div>
<p>Run the command below to download the data (4 GB in size):</p>
<div class="language-bash codeBlockContainer_ndbq theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_Zo7j"><pre tabindex="0" class="prism-code language-bash codeBlock_hgHP thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_EpfB"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token comment" style="color:hsl(230, 4%, 64%)"># switch to a data transfer node</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token plain">NetID@log-1 tensorflow_example</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token plain">$ </span><span class="token function" style="color:hsl(221, 87%, 60%)">ssh</span><span class="token plain"> gdtn</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token plain">NetID@dtn-1 ~</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token plain">$ </span><span class="token builtin class-name" style="color:hsl(35, 99%, 36%)">cd</span><span class="token plain"> /scratch/NetID/tensorflow_example</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token plain">NetID@dtn-1 tensorflow_example</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token plain">$ singularity </span><span class="token builtin class-name" style="color:hsl(35, 99%, 36%)">exec</span><span class="token plain"> </span><span class="token parameter variable" style="color:hsl(221, 87%, 60%)">--nv</span><span class="token plain"> </span><span class="token parameter variable" style="color:hsl(221, 87%, 60%)">--overlay</span><span class="token plain"> /scratch/NetID/pytorch-example/my_pytorch.ext3:ro /scratch/work/public/singularity/cuda12.1.1-cudnn8.9.0-devel-ubuntu22.04.2.sif /bin/bash </span><span class="token parameter variable" style="color:hsl(221, 87%, 60%)">-c</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;source /ext3/env.sh; python download_data_and_weights.py&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_wKjT" id="step-3-inspect-the-script">Step 3: Inspect the Script<a href="#step-3-inspect-the-script" class="hash-link" aria-label="Direct link to Step 3: Inspect the Script" title="Direct link to Step 3: Inspect the Script" translate="no">​</a></h3>
<p>Below is the contents of <code>mnist_classify.py</code>:</p>
<div class="language-python codeBlockContainer_ndbq theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_Zo7j"><pre tabindex="0" class="prism-code language-python codeBlock_hgHP thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_EpfB"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token keyword" style="color:hsl(301, 63%, 40%)">import</span><span class="token plain"> argparse</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">import</span><span class="token plain"> os</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">import</span><span class="token plain"> tensorflow_datasets </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">as</span><span class="token plain"> tfds</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">import</span><span class="token plain"> tensorflow </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">as</span><span class="token plain"> tf</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">from</span><span class="token plain"> time </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">import</span><span class="token plain"> perf_counter</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">def</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">preprocess_data</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">image</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> label</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  image </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> tf</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">image</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">resize</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">image</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token number" style="color:hsl(35, 99%, 36%)">300</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">300</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  image </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> tf</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">cast</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">image</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> tf</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">float32</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">/</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">255.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">return</span><span class="token plain"> image</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> label</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">def</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">create_dataset</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">batch_size_per_replica</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> datasets</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> strategy</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  batch_size </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> batch_size_per_replica </span><span class="token operator" style="color:hsl(221, 87%, 60%)">*</span><span class="token plain"> strategy</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">num_replicas_in_sync</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">return</span><span class="token plain"> datasets</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;train&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token builtin" style="color:hsl(119, 34%, 47%)">map</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">preprocess_data</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> num_parallel_calls</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain">tf</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">data</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">AUTOTUNE</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                          </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">cache</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                          </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">shuffle</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token number" style="color:hsl(35, 99%, 36%)">1000</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                          </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">batch</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">batch_size</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                          </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">prefetch</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">tf</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">data</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">AUTOTUNE</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">def</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">create_model</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">num_classes</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  base_model </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> tf</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">keras</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">applications</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">ResNet50</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">weights</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;imagenet&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> include_top</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token boolean" style="color:hsl(35, 99%, 36%)">False</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  x </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> base_model</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">output</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  x </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> tf</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">keras</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">layers</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">GlobalAveragePooling2D</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  x </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> tf</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">keras</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">layers</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">Dense</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token number" style="color:hsl(35, 99%, 36%)">1016</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> activation</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;relu&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  predictions </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> tf</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">keras</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">layers</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">Dense</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">num_classes</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> activation</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;softmax&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  model </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> tf</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">keras</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">Model</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">inputs</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain">base_model</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token builtin" style="color:hsl(119, 34%, 47%)">input</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> outputs</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain">predictions</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">return</span><span class="token plain"> model</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">def</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">train</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">epochs</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> num_classes</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> train_dataset</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> strategy</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">with</span><span class="token plain"> strategy</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">scope</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    model </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> create_model</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">num_classes</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    model</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token builtin" style="color:hsl(119, 34%, 47%)">compile</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">loss</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;sparse_categorical_crossentropy&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                  optimizer</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain">tf</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">keras</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">optimizers</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">Adam</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">learning_rate</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token number" style="color:hsl(35, 99%, 36%)">0.0001</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                  metrics</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;accuracy&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  start_time </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> perf_counter</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  model</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">fit</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">train_dataset</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> epochs</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain">epochs</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">print</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;Training time:&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> perf_counter</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">-</span><span class="token plain"> start_time</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">return</span><span class="token plain"> </span><span class="token boolean" style="color:hsl(35, 99%, 36%)">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">def</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">print_info</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">num_replicas_in_sync</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> batch_size_per_replica</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> info</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> num_classes</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">print</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">f&#x27;TF Version: </span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string-interpolation interpolation">tf</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token string-interpolation interpolation">__version__</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">print</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">f&#x27;Number of GPUs: </span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string-interpolation interpolation">num_replicas_in_sync</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">print</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">f&#x27;Batch size per GPU: </span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string-interpolation interpolation">batch_size_per_replica</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">print</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">f&#x27;Train records: </span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string-interpolation interpolation">info</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token string-interpolation interpolation">splits</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token string-interpolation interpolation string" style="color:hsl(119, 34%, 47%)">&quot;train&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token string-interpolation interpolation">num_examples</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">print</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">f&#x27;Test records:  </span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string-interpolation interpolation">info</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token string-interpolation interpolation">splits</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token string-interpolation interpolation string" style="color:hsl(119, 34%, 47%)">&quot;test&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token string-interpolation interpolation">num_examples</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">print</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">f&#x27;Number of classes: </span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string-interpolation interpolation">num_classes</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">return</span><span class="token plain"> </span><span class="token boolean" style="color:hsl(35, 99%, 36%)">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:hsl(221, 87%, 60%)">==</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;__main__&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  parser </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> argparse</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">ArgumentParser</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">description</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;Multi-GPU Training Example&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  parser</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">add_argument</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;--batch-size-per-replica&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">type</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token builtin" style="color:hsl(119, 34%, 47%)">int</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> default</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token number" style="color:hsl(35, 99%, 36%)">32</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> metavar</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;N&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                      </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">help</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;input batch size per GPU for training (default: 32)&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  parser</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">add_argument</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;--epochs&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">type</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token builtin" style="color:hsl(119, 34%, 47%)">int</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> default</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token number" style="color:hsl(35, 99%, 36%)">15</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> metavar</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;N&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                      </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">help</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;number of epochs to train (default: 15)&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  args </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> parser</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">parse_args</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  </span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  datasets</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> info </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> tfds</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">load</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">name</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;cassava&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> with_info</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token boolean" style="color:hsl(35, 99%, 36%)">True</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> as_supervised</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token boolean" style="color:hsl(35, 99%, 36%)">True</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> data_dir</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;.&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  num_classes </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> info</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">features</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;label&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">num_classes</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  strategy </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> tf</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">distribute</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">MirroredStrategy</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  train_dataset </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> create_dataset</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">args</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">batch_size_per_replica</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> datasets</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> strategy</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  train</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">args</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">epochs</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> num_classes</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> train_dataset</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> strategy</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  </span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  print_info</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">strategy</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">num_replicas_in_sync</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> args</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">batch_size_per_replica</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> info</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> num_classes</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_wKjT" id="step-4-submit-the-job">Step 4: Submit the Job<a href="#step-4-submit-the-job" class="hash-link" aria-label="Direct link to Step 4: Submit the Job" title="Direct link to Step 4: Submit the Job" translate="no">​</a></h3>
<p>Below is a sample Slurm script:</p>
<div class="language-bash codeBlockContainer_ndbq theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_Zo7j"><pre tabindex="0" class="prism-code language-bash codeBlock_hgHP thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_EpfB"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token shebang important" style="color:hsl(230, 8%, 24%);font-weight:bold">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)">#SBATCH --job-name=cassava       # create a short name for your job</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)">#SBATCH --nodes=1                # node count</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)">#SBATCH --ntasks=1               # total number of tasks across all nodes</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)">#SBATCH --cpus-per-task=16       # cpu-cores per task (&gt;1 if multi-threaded tasks)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)">#SBATCH --mem=64G                # total memory per node (4G per cpu-core is default)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)">#SBATCH --gres=gpu:2             # number of gpus per node</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)">#SBATCH --time=00:20:00          # total run time limit (HH:MM:SS)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">module purge</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">srun singularity </span><span class="token builtin class-name" style="color:hsl(35, 99%, 36%)">exec</span><span class="token plain"> </span><span class="token parameter variable" style="color:hsl(221, 87%, 60%)">--nv</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	    </span><span class="token parameter variable" style="color:hsl(221, 87%, 60%)">--overlay</span><span class="token plain"> /scratch/NetID/pytorch_examples_new/tensorflow-example/tensorflow.ext3:ro </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	    /scratch/work/public/singularity/cuda12.1.1-cudnn8.9.0-devel-ubuntu22.04.2.sif</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	    /bin/bash </span><span class="token parameter variable" style="color:hsl(221, 87%, 60%)">-c</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;source /ext3/env.sh; python mnist_classify.py --batch-size-per-replica=32 --epochs=15&quot;</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-note admonition_nT0D alert alert--secondary"><div class="admonitionHeading_v1P0"><span class="admonitionIcon_Vpqq"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_kdNk"><p>Be sure to change <code>NetID</code> in the above script to your NetID.</p></div></div>
<p>Submit the job as follows:</p>
<div class="language-bash codeBlockContainer_ndbq theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_Zo7j"><pre tabindex="0" class="prism-code language-bash codeBlock_hgHP thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_EpfB"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token plain">NetID@log-1 tensorflow_example</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token plain">$ sbatch job.slurm</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_wKjT" id="performance">Performance<a href="#performance" class="hash-link" aria-label="Direct link to Performance" title="Direct link to Performance" translate="no">​</a></h3>
<p>The training time is shown below for different choices of <code>cpus-per-task</code> and the number of GPUs on a test system (your results will vary depending on your system specs):</p>
<table><thead><tr><th style="text-align:center">nodes</th><th style="text-align:center">ntasks</th><th style="text-align:center">cpus-per-task</th><th style="text-align:center">GPUs</th><th style="text-align:center">Training Time (s)</th><th style="text-align:center">Mean GPU Utilization (%)</th></tr></thead><tbody><tr><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">2</td><td style="text-align:center">1</td><td style="text-align:center">574</td><td style="text-align:center">85</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">4</td><td style="text-align:center">1</td><td style="text-align:center">565</td><td style="text-align:center">83</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">8</td><td style="text-align:center">1</td><td style="text-align:center">562</td><td style="text-align:center">89</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">16</td><td style="text-align:center">1</td><td style="text-align:center">564</td><td style="text-align:center">90</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">4</td><td style="text-align:center">2</td><td style="text-align:center">339</td><td style="text-align:center">76</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">8</td><td style="text-align:center">2</td><td style="text-align:center">334</td><td style="text-align:center">81</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">16</td><td style="text-align:center">2</td><td style="text-align:center">332</td><td style="text-align:center">74</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">4</td><td style="text-align:center">3</td><td style="text-align:center">256</td><td style="text-align:center">68</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">8</td><td style="text-align:center">3</td><td style="text-align:center">251</td><td style="text-align:center">73</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">16</td><td style="text-align:center">3</td><td style="text-align:center">249</td><td style="text-align:center">66</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">4</td><td style="text-align:center">4</td><td style="text-align:center">226</td><td style="text-align:center">59</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">8</td><td style="text-align:center">4</td><td style="text-align:center">220</td><td style="text-align:center">58</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">16</td><td style="text-align:center">4</td><td style="text-align:center">214</td><td style="text-align:center">65</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">1</td><td style="text-align:center">32</td><td style="text-align:center">4</td><td style="text-align:center">218</td><td style="text-align:center">63</td></tr></tbody></table>
<p>&quot;Training Time&quot; in the table above is the time to run <code>model.fit(train_dataset, epochs=epochs)</code>. &quot;Mean GPU utilization&quot; was taken from the output of the <code>jobstats</code> command.</p>
<p>The figure below shows the speed-up as a function of the number of GPUs. The dashed line shows the maximum possible speed-up.</p>
<p><img decoding="async" loading="lazy" alt="speedup vs gpus plot" src="/assets/images/speedup_vs_gpus-4fda8a5563c539377160afb94ba97b6d.png" width="1000" height="600" class="img_XaWr"></p>
<p>We see that linear scaling is not observed. That is, the training time when using 2 GPUs is not 1/2 of the training time when using one. To improve on this one would profile the script and identify the performance bottleneck. Some of the training images are 500 pixels wide. It could be that the preprocessing step is the slowest.</p>
<h2 class="anchor anchorTargetStickyNavbar_wKjT" id="multi-node-training">Multi-node Training<a href="#multi-node-training" class="hash-link" aria-label="Direct link to Multi-node Training" title="Direct link to Multi-node Training" translate="no">​</a></h2>
<ul>
<li class=""><a href="https://www.tensorflow.org/guide/distributed_training#multiworkermirroredstrategy" target="_blank" rel="noopener noreferrer" class="">MultiWorkerMirroredStrategy</a> for using the GPUs on more than one compute node.</li>
<li class=""><a href="https://www.tensorflow.org/tutorials/distribute/multi_worker_with_keras" target="_blank" rel="noopener noreferrer" class="">Keras API</a>.</li>
<li class=""><a href="https://horovod.ai/" target="_blank" rel="noopener noreferrer" class="">Horovod</a> is a distributed deep learning training framework for TensorFlow, Keras, PyTorch, and Apache MXNet. It is based on MPI.</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_AAw7"><a href="https://github.com/NYU-RTS/rts-docs/blob/main/docs/hpc/08_ml_ai_hpc/04_tensorflow.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_OZ0G" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_RgrK"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/hpc/ml_ai_hpc/pytorch_dpp/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Multi-GPU Training with PyTorch: Distributed Data Parallel (DDP)</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/hpc/ml_ai_hpc/llm_fine_tuning/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Fine tune LLMs on HPC</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_Py9d thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#single-node-synchronous-multi-gpu-training" class="table-of-contents__link toc-highlight">Single-Node, Synchronous, Multi-GPU Training</a><ul><li><a href="#step-1-create-a-tensorflow-overlay-file" class="table-of-contents__link toc-highlight">Step 1: Create a TensorFlow Overlay File</a></li><li><a href="#step-2-download-the-data" class="table-of-contents__link toc-highlight">Step 2: Download the Data</a></li><li><a href="#step-3-inspect-the-script" class="table-of-contents__link toc-highlight">Step 3: Inspect the Script</a></li><li><a href="#step-4-submit-the-job" class="table-of-contents__link toc-highlight">Step 4: Submit the Job</a></li><li><a href="#performance" class="table-of-contents__link toc-highlight">Performance</a></li></ul></li><li><a href="#multi-node-training" class="table-of-contents__link toc-highlight">Multi-node Training</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Contact</div><ul class="footer__items clean-list"><li class="footer__item"><a href="mailto:hpc@nyu.edu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Email HPC support<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_NVDT"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="mailto:hsrn-support@nyu.edu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Email HSRN support<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_NVDT"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="mailto:research-cloud-support@nyu.edu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Email Research Cloud support<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_NVDT"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="mailto:srde-support@nyu.edu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Email Secure Research Data Environment support<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_NVDT"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="mailto:genai-support@nyu.edu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Email general GenAI support<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_NVDT"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="mailto:genai-research-support@nyu.edu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Email GenAI for research support<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_NVDT"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Links</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://guides.nyu.edu/" target="_blank" rel="noopener noreferrer" class="footer__link-item">NYU Libraries Research Guides<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_NVDT"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://sites.google.com/nyu.edu/forc-camp/home" target="_blank" rel="noopener noreferrer" class="footer__link-item">FORC camp<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_NVDT"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://docs.google.com/forms/d/e/1FAIpQLSeHnmkPdR_IvWnT6a7U_V3RpfmQrpS8hjxI11FNnsZMlrBa4g/viewform" target="_blank" rel="noopener noreferrer" class="footer__link-item">Feedback</a></li><li class="footer__item"><a class="footer__link-item" href="/blog/">Announcements</a></li><li class="footer__item"><a href="https://github.com/NYU-RTS/rts-docs" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_NVDT"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Made with 💜 in NYC!</div></div></div></footer></div>
</body>
</html>
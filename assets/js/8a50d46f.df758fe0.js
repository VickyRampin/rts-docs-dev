"use strict";(self.webpackChunkrts_docs=self.webpackChunkrts_docs||[]).push([["9366"],{41464(e,n,a){a.r(n),a.d(n,{metadata:()=>o,default:()=>h,frontMatter:()=>t,contentTitle:()=>l,toc:()=>d,assets:()=>c});var o=JSON.parse('{"id":"hpc/tools_and_software/conda_environments","title":"Conda Environments (Python, R)","description":"This page describes how you can create conda environments without containers in $SCRATCH//home/$USER. We strongly encourage you to create conda environments within Overlay files attached to Apptainer containers as described in this section. Please note that creating both kinds of conda environments is strongly discouraged as it leads to packages from one environment being accidentally used in another.","source":"@site/docs/hpc/06_tools_and_software/06_conda_environments.mdx","sourceDirName":"hpc/06_tools_and_software","slug":"/hpc/tools_and_software/conda_environments","permalink":"/docs/hpc/tools_and_software/conda_environments","draft":false,"unlisted":false,"editUrl":"https://github.com/NYU-RTS/rts-docs/blob/main/docs/hpc/06_tools_and_software/06_conda_environments.mdx","tags":[],"version":"current","sidebarPosition":6,"frontMatter":{},"sidebar":"hpcSidebar","previous":{"title":"R Packages with renv","permalink":"/docs/hpc/tools_and_software/r_packages_with_renv"},"next":{"title":"SQLite: Handling Large Structured Data","permalink":"/docs/hpc/tools_and_software/sqlite_handling_large_structured_data"}}'),i=a(62615),s=a(30416);let t={},l="Conda Environments (Python, R)",c={},d=[{value:"What is Conda?",id:"what-is-conda",level:2},{value:"Advantages/disadvantages of using Conda",id:"advantagesdisadvantages-of-using-conda",level:2},{value:"Advantages",id:"advantages",level:3},{value:"Disadvantages",id:"disadvantages",level:3},{value:"Initializing Conda",id:"initializing-conda",level:2},{value:"Prefix Conda Environments",id:"prefix-conda-environments",level:2},{value:"Python",id:"python",level:3},{value:"1. Load anaconda module and create local prefix environment",id:"1-load-anaconda-module-and-create-local-prefix-environment",level:4},{value:"2. Create a symbolic link so conda will download files for packages to be installed into scratch, not your home directory.",id:"2-create-a-symbolic-link-so-conda-will-download-files-for-packages-to-be-installed-into-scratch-not-your-home-directory",level:4},{value:"3. Other packages may be installed (and compiled when needed) using pip",id:"3-other-packages-may-be-installed-and-compiled-when-needed-using-pip",level:4},{value:"R",id:"r",level:3},{value:"1. Load anaconda module and create local prefix environment",id:"1-load-anaconda-module-and-create-local-prefix-environment-1",level:4},{value:"2. Install pre-compiled packages available in conda:",id:"2-install-pre-compiled-packages-available-in-conda",level:4},{value:"3. Other packages may be installed (and compiled) using install.packages()",id:"3-other-packages-may-be-installed-and-compiled-using-installpackages",level:4},{value:"Named Conda Environments",id:"named-conda-environments",level:2},{value:"Reproducibility",id:"reproducibility",level:2},{value:"Packages installed only using conda",id:"packages-installed-only-using-conda",level:3},{value:"Packages installed using conda and <code>pip</code> (Python)",id:"packages-installed-using-conda-and-pip-python",level:3},{value:"Packages installed using <code>install.packages</code> (R)",id:"packages-installed-using-installpackages-r",level:3},{value:"<code>renv</code>",id:"renv",level:4},{value:"Use conda env in a batch script",id:"use-conda-env-in-a-batch-script",level:2},{value:"Python",id:"python-1",level:3},{value:"Single node",id:"single-node",level:4},{value:"Multiple nodes, using MPI",id:"multiple-nodes-using-mpi",level:4},{value:"R (conda packages only)",id:"r-conda-packages-only",level:3},{value:"Multiple nodes, using MPI",id:"multiple-nodes-using-mpi-1",level:4},{value:"R (conda with renv combination)",id:"r-conda-with-renv-combination",level:3}];function r(e){let n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components},{Details:a}=n;return a||function(e,n){throw Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"conda-environments-python-r",children:"Conda Environments (Python, R)"})}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsxs)(n.p,{children:["This page describes how you can create conda environments without containers in ",(0,i.jsx)(n.code,{children:"$SCRATCH"}),"/",(0,i.jsx)(n.code,{children:"/home/$USER"}),". We strongly encourage you to create conda environments within Overlay files attached to Apptainer containers ",(0,i.jsx)(n.a,{href:"/docs/hpc/containers/singularity_with_conda",children:"as described in this section"}),". Please note that creating both kinds of conda environments is strongly discouraged as it leads to packages from one environment being accidentally used in another."]})}),"\n",(0,i.jsx)(n.h2,{id:"what-is-conda",children:"What is Conda?"}),"\n",(0,i.jsxs)(n.p,{children:["Package, dependency and environment management for any language\u2014Python, R, Ruby, Lua, Scala, Java, JavaScript, C/ C++, FORTRAN, and more. Please find more information at ",(0,i.jsx)(n.a,{href:"https://docs.conda.io/en/latest/",children:"the official documentation page"})]}),"\n",(0,i.jsxs)(n.p,{children:["Conda provides a great way to install packages that are already compiled, so you don't need to go over the long compilation process. If a package you need is not available, you can install it (and compile it when needed) using ",(0,i.jsx)(n.code,{children:"pip"})," (Python) or ",(0,i.jsx)(n.code,{children:"install.packages"})," (R)."]}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Reproducibility"}),":\nOne of the ways to ensure the reproducibility of your results is to have an independent conda environment in the directory of each project (one of the options shown below). This will also keep conda environment files away from your ",(0,i.jsx)(n.code,{children:"/home/$USER"})," directory."]})}),"\n",(0,i.jsx)(n.h2,{id:"advantagesdisadvantages-of-using-conda",children:"Advantages/disadvantages of using Conda"}),"\n",(0,i.jsx)(n.h3,{id:"advantages",children:"Advantages"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"A lot of pre-compiled packages (fast and easy to install)"}),"\n"]}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"For Python"}),": pip also offers pre-compiled packages (wheels). List can be found on ",(0,i.jsx)(n.a,{href:"https://pythonwheels.com",children:"Python Wheels"}),".\nHowever, Conda has a significantly larger number of pre-compiled packages."]})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Compiled packages use highly efficient Intel Math Kernel Library (MKL) library"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"disadvantages",children:"Disadvantages"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Conda does not take advantage of packages already installed in the system (while ",(0,i.jsx)(n.a,{href:"/docs/hpc/tools_and_software/python_packages_with_virtual_environments",children:"virtualenv and venv"})," do)"]}),"\n",(0,i.jsx)(n.li,{children:"As you will see below, you may need to do additional steps to keep track of all installed packages (including those installed by pip and/or install.packages)"}),"\n"]}),"\n",(0,i.jsxs)(a,{children:[(0,i.jsx)("summary",{children:(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Automatic deletion of your files"}),"\nFiles on the ",(0,i.jsx)(n.code,{children:"/scratch"})," file system that have not been accessed for 60 or more days will be purged (see ",(0,i.jsx)(n.a,{href:"/docs/hpc/storage/intro_and_data_management",children:"HPC Storage"})," for details). Click to see how you can work around this limitation."]})}),(0,i.jsxs)(n.admonition,{type:"tip",children:[(0,i.jsx)(n.p,{children:"Thus you can consider the following options:"}),(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Reinstall your packages if some of the files get deleted","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"You can do this manually"}),"\n",(0,i.jsxs)(n.li,{children:["You can do this automatically. For example, within a workflow of a pipeline software like ",(0,i.jsx)(n.a,{href:"https://www.nextflow.io/",children:"Nextflow"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:['Pay for "Research Project Space" - for details see ',(0,i.jsx)(n.a,{href:"/docs/hpc/storage/research_project_space",children:"Research Project Space"})]}),"\n",(0,i.jsxs)(n.li,{children:["Use Singularity and install packages within a corresponding overlay file - Details available at ",(0,i.jsx)(n.a,{href:"/docs/hpc/containers/squash_file_system_and_singularity",children:"Squash File System and Singularity"})]}),"\n"]})]})]}),"\n",(0,i.jsx)(n.h2,{id:"initializing-conda",children:"Initializing Conda"}),"\n",(0,i.jsx)(n.p,{children:"Load anaconda module"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"module purge\nmodule load anaconda3/2024.02\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Conda init can create problems with package installation, so we suggest using ",(0,i.jsx)(n.code,{children:"source activate"})," instead of ",(0,i.jsx)(n.code,{children:"conda activate"}),", even though conda activate is considered a best practice by the Anaconda developers."]}),"\n",(0,i.jsxs)(n.p,{children:["There are two main ways to create conda environments.  You can either define them with a name by using the ",(0,i.jsx)(n.code,{children:"-n"})," or ",(0,i.jsx)(n.code,{children:"--name"})," parameter or you can define them by full path (or prefix) using the ",(0,i.jsx)(n.code,{children:"-p"})," or ",(0,i.jsx)(n.code,{children:"--prefix"})," parameter."]}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsxs)(n.p,{children:["NYU HPC recommends using prefix environments as a best practice because it makes reproducibility easier as we will see below.  However, we do show how to use named environments with your ",(0,i.jsx)(n.code,{children:"/scratch"})," space, so you don't fill up your ",(0,i.jsx)(n.code,{children:"/home"})," space, if that's preferred."]})}),"\n",(0,i.jsx)(n.h2,{id:"prefix-conda-environments",children:"Prefix Conda Environments"}),"\n",(0,i.jsxs)(n.p,{children:["You can store your program/project in ",(0,i.jsx)(n.code,{children:"/scratch"})," and keep the conda environment with it by using the ",(0,i.jsx)(n.code,{children:"-p"})," parameter. This will keep all the files inside the project's directory, instead of putting in in your ",(0,i.jsx)(n.code,{children:"/home/$USER"}),". ",(0,i.jsx)("br",{}),"\nHere are details about how to do this for Python and R projects:"]}),"\n",(0,i.jsx)(n.h3,{id:"python",children:"Python"}),"\n",(0,i.jsx)(n.h4,{id:"1-load-anaconda-module-and-create-local-prefix-environment",children:"1. Load anaconda module and create local prefix environment"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"module purge\nmodule load anaconda3/2024.02\nconda create -p ./penv python  ## environment will be created in project directory\nsource activate ./penv \n"})}),"\n",(0,i.jsx)(n.h4,{id:"2-create-a-symbolic-link-so-conda-will-download-files-for-packages-to-be-installed-into-scratch-not-your-home-directory",children:"2. Create a symbolic link so conda will download files for packages to be installed into scratch, not your home directory."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"mkdir /home/<NetID>/.conda\nmkdir /scratch/<NetID>/conda_pkgs\nln -s /scratch/<NetID>/conda_pkgs /home/<NetID>/.conda/pkgs\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://anaconda.org/anaconda/repo",children:"Install pre-compiled packages available in conda"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"conda install -c anaconda pandas\n"})}),"\n",(0,i.jsx)(n.h4,{id:"3-other-packages-may-be-installed-and-compiled-when-needed-using-pip",children:"3. Other packages may be installed (and compiled when needed) using pip"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"pip install <package_name>\n"})}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:["Conda and packages install by default to ",(0,i.jsx)(n.code,{children:"~/.local/lib/python<version>"}),", so if you did use ",(0,i.jsx)(n.code,{children:"'pip install --user'"})," to install some packages (without conda or other virtual environment), they will be available in ",(0,i.jsx)(n.code,{children:"~/.local/lib/python<version>"})]})}),"\n",(0,i.jsxs)(n.admonition,{type:"warning",children:[(0,i.jsxs)(n.admonition,{title:"The primary takeaway:",type:"info",children:[(0,i.jsxs)(n.p,{children:["Let say you have tornado v.6 installed in ",(0,i.jsx)(n.code,{children:"~/.local/lib/python<version>"}),", and tornado v.5 installed by ",(0,i.jsx)(n.code,{children:"conda install"}),"."]}),(0,i.jsxs)(n.p,{children:["When you will do ",(0,i.jsx)(n.code,{children:"source activate"})," you will have tornado v.6 available!! Not v.5!!"]}),(0,i.jsxs)(n.p,{children:["(this behaviour is the same for packages installed by to ",(0,i.jsx)(n.code,{children:"~/.local/lib/python<version>"})," before or after you create your conda environment)"]}),(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"pip freeze"})," will give v.6"]}),(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"conda list"})," will give v.5"]})]}),(0,i.jsx)(n.admonition,{title:"Solution",type:"tip",children:(0,i.jsxs)(n.p,{children:["To overcome this, do ",(0,i.jsx)(n.code,{children:"export PYTHONNOUSERSITE=True"})," after source activate"]})})]}),"\n",(0,i.jsx)(n.h3,{id:"r",children:"R"}),"\n",(0,i.jsx)(n.h4,{id:"1-load-anaconda-module-and-create-local-prefix-environment-1",children:"1. Load anaconda module and create local prefix environment"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"module load anaconda3/2024.02\nconda create -p ./renv r=3.5 ## environment will be created in project directory\n## OR\nconda create -c conda-forge -p ./renv r-base=3.6.3 ## environment will be created in project directory\nsource activate ./renv\n"})}),"\n",(0,i.jsx)(n.h4,{id:"2-install-pre-compiled-packages-available-in-conda",children:"2. Install pre-compiled packages available in conda:"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://docs.anaconda.com/anaconda/packages/r-language-pkg-docs/",children:"https://docs.anaconda.com/anaconda/packages/r-language-pkg-docs/"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"conda install -c r r-dplyr\n"})}),"\n",(0,i.jsx)(n.h4,{id:"3-other-packages-may-be-installed-and-compiled-using-installpackages",children:"3. Other packages may be installed (and compiled) using install.packages()"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:'install.packages("<package_name>")\n'})}),"\n",(0,i.jsx)(n.h2,{id:"named-conda-environments",children:"Named Conda Environments"}),"\n",(0,i.jsx)(n.p,{children:"You can create a named conda environment with a command like:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"conda create --name <my-env>\n"})}),"\n",(0,i.jsxs)(n.p,{children:["You'll need to replace ",(0,i.jsx)(n.code,{children:"<my-env>"})," with the name of your environment."]}),"\n",(0,i.jsx)(n.p,{children:"We defined where the prefix environment is created in the creation command, so where is the named environment created for named conda environments?"}),"\n",(0,i.jsxs)(n.p,{children:["We can find this out by using the ",(0,i.jsx)(n.code,{children:"info"})," command with conda:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ conda info\n"})}),"\n",(0,i.jsx)(n.p,{children:"This should output something like:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"     active environment : None\n       user config file : /home/NetID/.condarc\n populated config files : \n          conda version : 24.1.2\n    conda-build version : 24.1.2\n         python version : 3.11.7.final.0\n                 solver : libmamba (default)\n       virtual packages : __archspec=1=cascadelake\n                          __conda=24.1.2=0\n                          __glibc=2.34=0\n                          __linux=5.14.0=0\n                          __unix=0=0\n       base environment : /share/apps/anaconda3/2024.02  (read only)\n      conda av data dir : /share/apps/anaconda3/2024.02/etc/conda\n  conda av metadata url : None\n           channel URLs : https://repo.anaconda.com/pkgs/main/linux-64\n                          https://repo.anaconda.com/pkgs/main/noarch\n                          https://repo.anaconda.com/pkgs/r/linux-64\n                          https://repo.anaconda.com/pkgs/r/noarch\n          package cache : /share/apps/anaconda3/2024.02/pkgs\n                          /home/NetID/.conda/pkgs\n       envs directories : /home/NetID/.conda/envs\n                          /share/apps/anaconda3/2024.02/envs\n               platform : linux-64\n             user-agent : conda/24.1.2 requests/2.31.0 CPython/3.11.7 Linux/5.14.0-284.86.1.el9_2.x86_64 rhel/9.2 glibc/2.34 solver/libmamba conda-libmamba-solver/24.1.0 libmambapy/1.5.6 aau/0.4.3 c/U4Vmh2Rw4idTcwqzLhNX1g s/2MYchdSIR4EFcYeOthelfQ\n                UID:GID : 402570:402570\n             netrc file : None\n           offline mode : False\n"})}),"\n",(0,i.jsxs)(n.p,{children:["You can see in this output the default location for your ",(0,i.jsx)(n.code,{children:"package cache"})," and your ",(0,i.jsx)(n.code,{children:"envs directories"}),".  They're currently set to subdirectories of our home directory.  If we create named environments with these setting we will very quickly fill up our limited home directory space.  The solution to this is to create or modify our personal conda config file to change these settings.  You can see the setting above for ",(0,i.jsx)(n.code,{children:"user config file"})," tells us the location of the file where we can make changes to these defaults.  If the file doesn't exist you'll need to create it.  You may also need to change the config file location if your output from ",(0,i.jsx)(n.code,{children:"conda info"})," differs from the above."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ nano /home/NetID/.condarc\n"})}),"\n",(0,i.jsx)(n.p,{children:"Now add the following lines to your config file:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"envs_dirs:\n  - /scratch/NetID/conda_envs\npkgs_dirs:\n  - /scratch/NetID/conda_pkgs\nalways_copy: true\n"})}),"\n",(0,i.jsx)(n.p,{children:"You'll need to create those directories if they don't exist:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ mkdir /scratch/NetID/conda_envs\n$ mkdir /scratch/NetID/conda_pkgs\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Don't forget to change ",(0,i.jsx)(n.code,{children:"NetID"})," above to your ",(0,i.jsx)(n.code,{children:"NetID"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["You should now see that the ",(0,i.jsx)(n.code,{children:"package cache"})," and ",(0,i.jsx)(n.code,{children:"envs directories"})," entries have changed to your ",(0,i.jsx)(n.code,{children:"/scratch"})," space when you run ",(0,i.jsx)(n.code,{children:"conda info"})," and packages and environments will be saved on your ",(0,i.jsx)(n.code,{children:"/scratch"})," space for all named conda environments."]}),"\n",(0,i.jsx)(n.h2,{id:"reproducibility",children:"Reproducibility"}),"\n",(0,i.jsx)(n.h3,{id:"packages-installed-only-using-conda",children:"Packages installed only using conda"}),"\n",(0,i.jsx)(n.p,{children:"Save a list of packages (so you are able to report the environment in a publication, and to restore/reproduce the environment on another machine at any time)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# save\nconda list --export > requirements.txt\n# restore\nconda create -p ./penv --file requirements.txt\n"})}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:["This will not list packages installed by ",(0,i.jsx)(n.code,{children:"pip"})," or ",(0,i.jsx)(n.code,{children:"install.packages()"})]})}),"\n",(0,i.jsxs)(n.h3,{id:"packages-installed-using-conda-and-pip-python",children:["Packages installed using conda and ",(0,i.jsx)(n.code,{children:"pip"})," (Python)"]}),"\n",(0,i.jsx)(n.p,{children:"In this case you can use:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"export PYTHONNOUSERSITE=True  ## to ignore packages in ~/.local/lib/python<version>\n# save\nconda list --export > conda_requirements.txt\npip freeze > pip_requirements.txt\n# restore\nconda create -p ./penv --file conda_requirements.txt\npip install -r pip_requirements.txt\n"})}),"\n",(0,i.jsxs)(n.admonition,{type:"tip",children:[(0,i.jsxs)(n.p,{children:["Alternatively, you can use ",(0,i.jsx)(n.code,{children:"conda env export > all_requirements.txt"}),", which will save both: packages installed by conda and ",(0,i.jsx)(n.code,{children:"pip"}),"."]}),(0,i.jsx)(n.admonition,{type:"warning",children:(0,i.jsx)(n.p,{children:"However, this may fail if your conda environment is created as a sub-directory of your project's directory (which we recommend)"})})]}),"\n",(0,i.jsxs)(n.h3,{id:"packages-installed-using-installpackages-r",children:["Packages installed using ",(0,i.jsx)(n.code,{children:"install.packages"})," (R)"]}),"\n",(0,i.jsxs)(n.p,{children:["The command ",(0,i.jsx)(n.code,{children:"conda list --export"})," will not include packages installed by ",(0,i.jsx)(n.code,{children:"install.packages"}),". So, only use ",(0,i.jsx)(n.code,{children:"conda install"})," to install R and use ",(0,i.jsx)(n.code,{children:"renv"})," to maintain information about packages installed by ",(0,i.jsx)(n.code,{children:"install.packages"}),"."]}),"\n",(0,i.jsx)(n.h4,{id:"renv",children:(0,i.jsx)(n.code,{children:"renv"})}),"\n",(0,i.jsxs)(n.p,{children:["Please see details of using ",(0,i.jsx)(n.code,{children:"renv"})," with conda for reproducibilty on ",(0,i.jsxs)(n.a,{href:"/docs/hpc/tools_and_software/r_packages_with_renv",children:["R packages with ",(0,i.jsx)(n.code,{children:"renv"})]}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"use-conda-env-in-a-batch-script",children:"Use conda env in a batch script"}),"\n",(0,i.jsx)(n.p,{children:"The part of the batch script that will call the command should look like:"}),"\n",(0,i.jsx)(n.h3,{id:"python-1",children:"Python"}),"\n",(0,i.jsx)(n.h4,{id:"single-node",children:"Single node"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"#!/bin/bash\n#SBATCH --job-name=test\n#SBATCH --nodes=1\n#SBATCH --cpus-per-task=1\n#SBATCH --ntasks-per-node=4\n#SBATCH --mem=8GB\n#SBATCH --time=1:00:00\nmodule purge;\nmodule load anaconda3/2024.02;\nexport OMP_NUM_THREADS=$SLURM_CPUS_PER_TASK;\nsource /share/apps/anaconda3/2020.07/etc/profile.d/conda.sh;\nexport PATH_TO_ENV=<full path to penv>\nsource activate $PATH_TO_ENV;\nexport PATH=$PATH_TO_ENV/bin:$PATH;\npython test.py\n\n"})}),"\n",(0,i.jsxs)(n.p,{children:["You'll need to replace ",(0,i.jsx)(n.code,{children:"<full path to penv>"})," with the full path to your penv directory.  It's probably something like ",(0,i.jsx)(n.code,{children:"/scratch/NetID/conda_tests/penv"})]}),"\n",(0,i.jsx)(n.h4,{id:"multiple-nodes-using-mpi",children:"Multiple nodes, using MPI"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:'#!/bin/bash\n#SBATCH --job-name=test\n#SBATCH --nodes=1\n#SBATCH --cpus-per-task=1\n#SBATCH --ntasks-per-node=4\n#SBATCH --mem=8GB\n#SBATCH --time=1:00:00\nexport PATH_TO_ENV="<full path to penv>"\nmodule purge;\nmodule load openmpi/gcc/4.1.6;\nmpiexec bash -c "module purge;\nexport OMP_NUM_THREADS=$SLURM_CPUS_PER_TASK;\nmodule load anaconda3/2024.02;\nsource /share/apps/anaconda3/2024.02/etc/profile.d/conda.sh;\nsource activate "$PATH_TO_ENV";\nexport PATH="$PATH_TO_ENV/bin:$PATH";\npython test.py"\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Again, you'll need to replace ",(0,i.jsx)(n.code,{children:"<full path to penv>"})," above with the full path to your penv directory."]}),"\n",(0,i.jsx)(n.h3,{id:"r-conda-packages-only",children:"R (conda packages only)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"#!/bin/bash\n#SBATCH --job-name=test\n#SBATCH --nodes=1\n#SBATCH --cpus-per-task=1\n#SBATCH --ntasks-per-node=4\n#SBATCH --mem=8GB\n#SBATCH --time=1:00:00\nmodule purge;\nmodule load anaconda3/2024.02;\nexport OMP_NUM_THREADS=$SLURM_CPUS_PER_TASK;\nsource /share/apps/anaconda3/2024.02/etc/profile.d/conda.sh;\nexport PATH_TO_ENV=<full path to renv>;\nsource activate $PATH_TO_ENV;\nexport PATH=$PATH_TO_ENV/bin:$PATH;\nRscript r_script.R\n"})}),"\n",(0,i.jsxs)(n.p,{children:["You'll again need to replace ",(0,i.jsx)(n.code,{children:"<full path to renv>"})," above with the full path to your renv directory."]}),"\n",(0,i.jsx)(n.h4,{id:"multiple-nodes-using-mpi-1",children:"Multiple nodes, using MPI"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:'#!/bin/bash\n#SBATCH --job-name=test\n#SBATCH --nodes=2\n#SBATCH --cpus-per-task=2\n#SBATCH --ntasks-per-node=4\n#SBATCH --mem=8GB\n#SBATCH --time=1:00:00\nmodule purge;\nmodule load anaconda3/2024.02;\nexport OMP_NUM_THREADS=$SLURM_CPUS_PER_TASK;\nsource /share/apps/anaconda3/2024.02/etc/profile.d/conda.sh;\nexport PATH_TO_ENV="<full path to renv>";\nsource activate $PATH_TO_ENV;\nexport PATH=$PATH_TO_ENV/bin:$PATH;\nRscript test.R\n'})}),"\n",(0,i.jsxs)(n.p,{children:["You'll again need to replace ",(0,i.jsx)(n.code,{children:"<full path to renv>"})," above with the full path to your renv directory."]}),"\n",(0,i.jsx)(n.h3,{id:"r-conda-with-renv-combination",children:"R (conda with renv combination)"}),"\n",(0,i.jsx)(n.p,{children:"In this case, when you use sbatch you would activate conda in sbatch script, and R script will pickup packages installed in renv"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"#!/bin/bash\n#SBATCH --job-name=test\n#SBATCH --nodes=2\n#SBATCH --cpus-per-task=2\n#SBATCH --ntasks-per-node=4\n#SBATCH --mem=8GB\n#SBATCH --time=1:00:00module purge\nmodule load anaconda3/2024.02\nsource /share/apps/anaconda3/2024.02/etc/profile.d/conda.sh\nsource activate <full path to renv>\nRscript test.R\n"})}),"\n",(0,i.jsxs)(n.p,{children:["You'll again need to replace ",(0,i.jsx)(n.code,{children:"<full path to renv>"})," above with the full path to your renv directory."]})]})}function h(e={}){let{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(r,{...e})}):r(e)}},30416(e,n,a){a.d(n,{R:()=>t,x:()=>l});var o=a(59471);let i={},s=o.createContext(i);function t(e){let n=o.useContext(s);return o.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:t(e.components),o.createElement(s.Provider,{value:n},e.children)}}}]);
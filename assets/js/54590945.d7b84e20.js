"use strict";(self.webpackChunkrts_docs=self.webpackChunkrts_docs||[]).push([["7895"],{63131(e,n,i){i.r(n),i.d(n,{metadata:()=>t,default:()=>d,frontMatter:()=>r,contentTitle:()=>l,toc:()=>c,assets:()=>s});var t=JSON.parse('{"id":"hpc/ood/jupyter_with_conda_singularity","title":"Jupyter Notebook with Conda/Singularity in OOD","description":"Please note that Greene and Torch organize overlay files and Singularity images in different directories.","source":"@site/docs/hpc/09_ood/07_jupyter_with_conda_singularity.mdx","sourceDirName":"hpc/09_ood","slug":"/hpc/ood/jupyter_with_conda_singularity","permalink":"/docs/hpc/ood/jupyter_with_conda_singularity","draft":false,"unlisted":false,"editUrl":"https://github.com/NYU-RTS/rts-docs/blob/main/docs/hpc/09_ood/07_jupyter_with_conda_singularity.mdx","tags":[],"version":"current","sidebarPosition":7,"frontMatter":{},"sidebar":"hpcSidebar","previous":{"title":"JBrowse Genome Browser in OOD","permalink":"/docs/hpc/ood/jbrowse_genome_browser"},"next":{"title":"Matlab-Proxy in OOD","permalink":"/docs/hpc/ood/matlab_proxy"}}'),o=i(62615),a=i(30416);let r={},l="Jupyter Notebook with Conda/Singularity in OOD",s={},c=[{value:"Greene Directories",id:"greene-directories",level:2},{value:"Torch Directories",id:"torch-directories",level:2},{value:"OOD + Singularity + conda",id:"ood--singularity--conda",level:2},{value:"Log Into Torch via the Terminal",id:"log-into-torch-via-the-terminal",level:3},{value:"Preinstallation Warning",id:"preinstallation-warning",level:3},{value:"Prepare Overlay File",id:"prepare-overlay-file",level:3},{value:"Launch Singularity Environment for Installation",id:"launch-singularity-environment-for-installation",level:3},{value:"Install Miniforge to Overlay File",id:"install-miniforge-to-overlay-file",level:3},{value:"Install Packages to Miniforge Environment",id:"install-packages-to-miniforge-environment",level:3},{value:"Configure iPython Kernels",id:"configure-ipython-kernels",level:3},{value:"Launch an OOD Jupyter Notebook",id:"launch-an-ood-jupyter-notebook",level:3},{value:"Configure and Launch your Notebook",id:"configure-and-launch-your-notebook",level:3},{value:"Select kernel",id:"select-kernel",level:3}];function h(e){let n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",mdxAdmonitionTitle:"mdxAdmonitionTitle",p:"p",pre:"pre",...(0,a.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"jupyter-notebook-with-condasingularity-in-ood",children:"Jupyter Notebook with Conda/Singularity in OOD"})}),"\n",(0,o.jsx)(n.p,{children:"Please note that Greene and Torch organize overlay files and Singularity images in different directories."}),"\n",(0,o.jsx)(n.h2,{id:"greene-directories",children:"Greene Directories"}),"\n",(0,o.jsx)(n.p,{children:"Overlay Files:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"/scratch/work/public/overlay-fs-ext3/\n"})}),"\n",(0,o.jsx)(n.p,{children:"Singularity Files:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"/scratch/work/public/singularity/\n"})}),"\n",(0,o.jsx)(n.h2,{id:"torch-directories",children:"Torch Directories"}),"\n",(0,o.jsx)(n.p,{children:"Overlay Files:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"/share/apps/overlay-fs-ext3\n"})}),"\n",(0,o.jsx)(n.p,{children:"Singularity Files:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"/share/apps/images/\n"})}),"\n",(0,o.jsx)(n.h2,{id:"ood--singularity--conda",children:"OOD + Singularity + conda"}),"\n",(0,o.jsx)(n.p,{children:"This page describes how to use your Singularity with conda environment in OOD GUI at Torch."}),"\n",(0,o.jsx)(n.h3,{id:"log-into-torch-via-the-terminal",children:"Log Into Torch via the Terminal"}),"\n",(0,o.jsxs)(n.p,{children:["The following commands must be run from the terminal. Information on accessing via the terminal can be found at ",(0,o.jsx)(n.a,{href:"/docs/hpc/connecting_to_hpc/connecting_to_hpc",children:"Connecting to the HPC"})," or you can log into OOD and select the ",(0,o.jsx)(n.code,{children:"Clusters"})," tab at the top of the page and select ",(0,o.jsx)(n.code,{children:"Torch Shell Access"}),"."]}),"\n",(0,o.jsx)(n.h3,{id:"preinstallation-warning",children:"Preinstallation Warning"}),"\n",(0,o.jsxs)(n.admonition,{type:"warning",children:[(0,o.jsx)(n.p,{children:"If you have initialized Conda in your base environment, your prompt on Torch may show something like:"}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"(base) [NetID@log-1 ~]$\n"})}),(0,o.jsxs)(n.p,{children:["then you must first comment out or remove this portion of your ",(0,o.jsx)(n.code,{children:"~/.bashrc"})," file:"]}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'# >>> conda initialize >>>\n# !! Contents within this block are managed by \'conda init\' !!\n__conda_setup="$(\'/share/apps/anaconda3/2020.07/bin/conda\' \'shell.bash\' \'hook\' 2> /dev/null)"\nif [ $? -eq 0 ]; then\n    eval "$__conda_setup"\nelse\n    if [ -f "/share/apps/anaconda3/2020.07/etc/profile.d/conda.sh" ]; then\n        . "/share/apps/anaconda3/2020.07/etc/profile.d/conda.sh"\n    else\n        export PATH="/share/apps/anaconda3/2020.07/bin:$PATH"\n    fi\nfi\nunset __conda_setup\n# <<< conda initialize <<<\n'})}),(0,o.jsx)(n.p,{children:"The above code automatically makes your environment look for the default shared installation of Conda on the cluster and will sabotage  any attempts to install packages to a Singularity environment. Once removed or commented out, log out and back into the cluster for a fresh environment."})]}),"\n",(0,o.jsx)(n.h3,{id:"prepare-overlay-file",children:"Prepare Overlay File"}),"\n",(0,o.jsx)(n.p,{children:"First, start a job to work on the compute nodes."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'[NetID@log-1 my_env]$ sbatch --cpus-per-task=2 --mem=10GB --time=04:00:00 --wrap "sleep infinity"\n\n# wait to be assigned a node then SSH to the node\n'})}),"\n",(0,o.jsx)(n.p,{children:"Once you SSH to the node, you can begin setting up the environment."}),"\n",(0,o.jsxs)(n.admonition,{title:"Files will not properly compile on the login nodes as they have different Red Hat OS images than the compute nodes. All compilation and package installation must be done on the compute nodes.",type:"note",children:[(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"[NetID@log-1 ~]$ mkdir /scratch/$USER/my_env\n[NetID@log-1 ~]$ cd /scratch/$USER/my_env\n[NetID@log-1 my_env]$ cp -rp /share/apps/overlay-fs-ext3/overlay-15GB-500K.ext3.gz .\n[NetID@log-1 my_env]$ gunzip overlay-15GB-500K.ext3.gz\n"})}),(0,o.jsxs)(n.p,{children:["Above we used the overlay file ",(0,o.jsx)(n.code,{children:"overlay-15GB-500K.ext3.gz"})," which will contain all of the installed packages. There are more optional overlay files. You can find instructions on the following pages: ",(0,o.jsx)(n.a,{href:"/docs/hpc/containers/singularity_with_conda",children:"Singularity with Conda"}),", ",(0,o.jsx)(n.a,{href:"/docs/hpc/containers/squash_file_system_and_singularity",children:"Squash File System and Singularity"}),"."]}),(0,o.jsx)(n.h3,{id:"launch-singularity-environment-for-installation",children:"Launch Singularity Environment for Installation"}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"[NetID@log-1 ~]$ singularity exec --fakeroot --overlay /scratch/$USER/my_env/overlay-15GB-500K.ext3:rw /share/apps/images/cuda12.3.2-cudnn9.0.0-ubuntu-22.04.4.sif /bin/bash\n"})}),(0,o.jsxs)(n.p,{children:["Above we used the Singularity OS image ",(0,o.jsx)(n.code,{children:"cuda12.3.2-cudnn9.0.0-ubuntu-22.04.4.sif"})," which provides the base operating system environment for the conda environment. There are other Singularity OS images available at ",(0,o.jsx)(n.code,{children:"/share/apps/images"})]}),(0,o.jsxs)(n.p,{children:["Launching Singularity with the ",(0,o.jsx)(n.code,{children:"--overlay"})," flag mounts the overlay file to a new directory: ",(0,o.jsx)(n.code,{children:"/ext3"})," - you will notice that when not using Singularity ",(0,o.jsx)(n.code,{children:"/ext3"})," is not available."]}),(0,o.jsxs)(n.admonition,{type:"warning",children:[(0,o.jsxs)(n.p,{children:["Be sure that you have the Singularity prompt (",(0,o.jsx)(n.code,{children:"Singularity>"}),") and that ",(0,o.jsx)(n.code,{children:"/ext3"})," is available before the next step."]}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"Singularity> ls -lah /ext3\ntotal 8.5K\ndrwxrwxr-x.  2 root root 4.0K Oct 19 10:01 .\ndrwx------. 29 root root 8.0K Oct 19 10:01 ..\n"})})]})]}),"\n",(0,o.jsx)(n.h3,{id:"install-miniforge-to-overlay-file",children:"Install Miniforge to Overlay File"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"Singularity> wget --no-check-certificate https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-x86_64.sh\nSingularity> sh Miniforge3-Linux-x86_64.sh -b -p /ext3/miniforge3\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Next, create a wrapper script at ",(0,o.jsx)(n.code,{children:"/ext3/env.sh"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"Singularity> touch /ext3/env.sh\nSingularity> echo '#!/bin/bash' >> /ext3/env.sh\nSingularity> echo 'unset -f which' >> /ext3/env.sh\nSingularity> echo 'source /ext3/miniforge3/etc/profile.d/conda.sh' >> /ext3/env.sh\nSingularity> echo 'export PATH=/ext3/miniforge3/bin:$PATH'         >> /ext3/env.sh\nSingularity> echo 'export PYTHONPATH=/ext3/miniforge3/bin:$PATH'   >> /ext3/env.sh\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Your ",(0,o.jsx)(n.code,{children:"/ext3/env.sh"})," file should now contain the following:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"#!/bin/bash\nunset -f which\nsource /ext3/miniforge3/etc/profile.d/conda.sh\nexport PATH=/ext3/miniforge3/bin:$PATH\nexport PYTHONPATH=/ext3/miniforge3/bin:$PATH\n"})}),"\n",(0,o.jsx)(n.p,{children:"The wrapper script will activate your conda environment, to which you will be installing your packages and dependencies."}),"\n",(0,o.jsx)(n.p,{children:"Next, activate your conda environment with the following:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"Singularity> source /ext3/env.sh\n"})}),"\n",(0,o.jsx)(n.h3,{id:"install-packages-to-miniforge-environment",children:"Install Packages to Miniforge Environment"}),"\n",(0,o.jsx)(n.p,{children:"Now that your environment is activated, you can update and install packages:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"Singularity> conda config --remove channels defaults\nSingularity> conda update -n base conda -y\nSingularity> conda clean --all --yes\nSingularity> conda install pip --yes\nSingularity> conda install ipykernel --yes # Note: ipykernel is required to run as a kernel in the Open OnDemand Jupyter Notebooks\n"})}),"\n",(0,o.jsx)(n.p,{children:"To confirm that your environment is appropriately referencing your Miniforge installation, try out the following:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"Singularity> unset which\nSingularity> which conda\n# output: /ext3/miniforge3/bin/conda\n\nSingularity> which python\n# output: /ext3/miniforge3/bin/python\n\nSingularity> python --version\n# output: Python 3.12.9\n\nSingularity> which pip\n# output: /ext3/miniforge3/bin/pip\n"})}),"\n",(0,o.jsx)(n.p,{children:"Now use either conda or pip to install your required python packages to the Miniforge environment."}),"\n",(0,o.jsxs)(n.admonition,{type:"note",children:[(0,o.jsxs)(n.mdxAdmonitionTitle,{children:["If using Apptainer (the default Singularity installation on Torch) be sure to use the --fakeroot flag when launching overlay files in read-write mode (",":rw",")."]}),(0,o.jsx)(n.p,{children:"To install larger packages, like Tensorflow, you must first start an interactive job with adequate compute and memory resources to install packages. The login nodes restrict memory to 2GB per user, which may cause some large packages to crash."}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'Singularity> exit\n\n[NetID@log-1 my_env]$ sbatch --cpus-per-task=2 --mem=10GB --time=04:00:00 --wrap "sleep infinity"\n\n# wait to be assigned a node then SSH to the node\n\n[NetID@cm001 my_env]$ singularity exec --fakeroot --overlay /scratch/$USER/my_env/overlay-15GB-500K.ext3:rw /share/apps/images/cuda12.3.2-cudnn9.0.0-ubuntu-22.04.4.sif /bin/bash\n\nSingularity> source /ext3/env.sh\n# activate the environment\n'})}),(0,o.jsx)(n.p,{children:"After it is running, you\u2019ll be redirected to a compute node. From there, run singularity to setup on conda environment, same as you were doing on login node."}),(0,o.jsx)(n.h3,{id:"configure-ipython-kernels",children:"Configure iPython Kernels"}),(0,o.jsxs)(n.p,{children:["To create a kernel named my_env copy the template files to your home directory.\nPlease note that kernel_template on Greene is stored under ",(0,o.jsx)(n.code,{children:"/share/apps/mypy/src/kernel_template"})]}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",metastring:"sh",children:"Singularity> mkdir -p ~/.local/share/jupyter/kernels\nSingularity> cd ~/.local/share/jupyter/kernels\nSingularity> cp -R /share/apps/kernel_template ./my_env # this should be the name of your Singularity env\n\nSingularity> cd ./my_env \n\nSingularity> ls\n#kernel.json  logo-32x32.png  logo-64x64.png  python # files in the ~/.local/share/jupyter/kernels directory\n"})}),(0,o.jsxs)(n.p,{children:["To set the conda environment, edit the file named ",(0,o.jsx)(n.code,{children:"python"})," in ",(0,o.jsx)(n.code,{children:"/.local/share/jupyter/kernels/my_env/"}),"."]}),(0,o.jsx)(n.p,{children:"The python file is a wrapper script that the Jupyter notebook will use to launch your Singularity container and attach it to the notebook."}),(0,o.jsx)(n.p,{children:"At the bottom of the file we have the template singularity command."}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'singularity exec $nv \\\n  --overlay /scratch/$USER/my_env/overlay-15GB-500K.ext3:ro \\\n  /share/apps/images/cuda12.3.2-cudnn9.0.0-ubuntu-22.04.4.sif \\\n  /bin/bash -c "source /ext3/env.sh; $cmd $args"\n'})}),(0,o.jsx)(n.admonition,{type:"warning",children:(0,o.jsx)(n.p,{children:"If you used a different overlay (/scratch/$USER/my_env/overlay-15GB-500K.ext3 shown above) or .sif file (/share/apps/images/cuda12.3.2-cudnn9.0.0-ubuntu-22.04.4.sif shown above), you MUST change those lines in the command above to the files you used."})})]}),"\n",(0,o.jsxs)(n.p,{children:["Edit the default ",(0,o.jsx)(n.code,{children:"kernel.json"})," file by setting PYTHON_LOCATION and KERNEL_DISPLAY_NAME using a text editor like nano/vim."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",children:'{\n "argv": [\n  "PYTHON_LOCATION",\n  "-m",\n  "ipykernel_launcher",\n  "-f",\n  "{connection_file}"\n ],\n "display_name": "KERNEL_DISPLAY_NAME",\n "language": "python"\n}\n'})}),"\n",(0,o.jsx)(n.p,{children:"to"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",children:'{\n "argv": [\n  "/home/<Your NetID>/.local/share/jupyter/kernels/my_env/python",\n  "-m",\n  "ipykernel_launcher",\n  "-f",\n  "{connection_file}"\n ],\n "display_name": "my_env",\n "language": "python"\n}\n'})}),"\n",(0,o.jsxs)(n.p,{children:["Update the ",(0,o.jsx)(n.code,{children:'"<Your NetID>"'})," to your own NetID without the ",(0,o.jsx)(n.code,{children:'"<>"'})," symbols."]}),"\n",(0,o.jsx)(n.h3,{id:"launch-an-ood-jupyter-notebook",children:"Launch an OOD Jupyter Notebook"}),"\n",(0,o.jsxs)(n.p,{children:["Go to ",(0,o.jsx)(n.a,{href:"https://ood.torch.hpc.nyu.edu",children:"https://ood.torch.hpc.nyu.edu"})," ",(0,o.jsx)("br",{}),"\nand select Jupyter Notebook from the Interactive Apps pull-down menu:"]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"OOD Launch",src:i(52173).A+"",width:"808",height:"675"})}),"\n",(0,o.jsx)(n.h3,{id:"configure-and-launch-your-notebook",children:"Configure and Launch your Notebook"}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"Configure Notebook",src:i(61959).A+"",width:"901",height:"1168"})}),"\n",(0,o.jsx)(n.h3,{id:"select-kernel",children:"Select kernel"}),"\n",(0,o.jsx)(n.p,{children:'Once configured and launched, kernels can be selected in the "New" dropdown or within the notebook under the kernel menu. Please note that your notebook view may look slightly different depending on available directories and environments, as well as if you choose the lab or traditional notebook view.'}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"Select Kernel",src:i(95355).A+"",width:"1280",height:"884"})})]})}function d(e={}){let{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(h,{...e})}):h(e)}},61959(e,n,i){i.d(n,{A:()=>t});let t=i.p+"assets/images/configure_notebook-cbb0519d367e164591f44822fcfe0f79.png"},95355(e,n,i){i.d(n,{A:()=>t});let t=i.p+"assets/images/select_kernel-7e551016b02a751f51275d0fad706d43.png"},52173(e,n,i){i.d(n,{A:()=>t});let t=i.p+"assets/images/start_jupyter-cd1b88605a808d7e3d1847762f4b4c5c.png"},30416(e,n,i){i.d(n,{R:()=>r,x:()=>l});var t=i(59471);let o={},a=t.createContext(o);function r(e){let n=t.useContext(a);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);
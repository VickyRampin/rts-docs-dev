"use strict";(self.webpackChunkrts_docs=self.webpackChunkrts_docs||[]).push([["1978"],{68887(e,n,t){t.r(n),t.d(n,{metadata:()=>i,default:()=>h,frontMatter:()=>l,contentTitle:()=>r,toc:()=>d,assets:()=>o});var i=JSON.parse('{"id":"hpc/tools_and_software/sqlite_handling_large_structured_data","title":"SQLite: Handling Large Structured Data","description":"Overview","source":"@site/docs/hpc/06_tools_and_software/07_sqlite_handling_large_structured_data.md","sourceDirName":"hpc/06_tools_and_software","slug":"/hpc/tools_and_software/sqlite_handling_large_structured_data","permalink":"/docs/hpc/tools_and_software/sqlite_handling_large_structured_data","draft":false,"unlisted":false,"editUrl":"https://github.com/NYU-RTS/rts-docs/blob/main/docs/hpc/06_tools_and_software/07_sqlite_handling_large_structured_data.md","tags":[],"version":"current","sidebarPosition":7,"frontMatter":{},"sidebar":"hpcSidebar","previous":{"title":"Conda Environments (Python, R)","permalink":"/docs/hpc/tools_and_software/conda_environments"},"next":{"title":"Custom Applications with Containers","permalink":"/docs/hpc/containers/intro"}}'),s=t(62615),a=t(30416);let l={},r="SQLite: Handling Large Structured Data",o={},d=[{value:"Overview",id:"overview",level:2},{value:"Some use-cases",id:"some-use-cases",level:3},{value:"Benefits:",id:"benefits",level:3},{value:"Major benefits of SQLite compared to MySQL (PostgreSQL, etc)",id:"major-benefits-of-sqlite-compared-to-mysql-postgresql-etc",level:3},{value:"Limits",id:"limits",level:3},{value:"Command line (CLI) example",id:"command-line-cli-example",level:2},{value:"R example",id:"r-example",level:2},{value:"Install",id:"install",level:3},{value:"Use",id:"use",level:3},{value:"Alternative: read csv file to SQLite directly",id:"alternative-read-csv-file-to-sqlite-directly",level:3},{value:"UI for SQLite - SQLiteStudio",id:"ui-for-sqlite---sqlitestudio",level:2}];function c(e){let n={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"sqlite-handling-large-structured-data",children:"SQLite: Handling Large Structured Data"})}),"\n",(0,s.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsxs)(n.p,{children:["Storing your data in the ",(0,s.jsx)(n.a,{href:"https://www.sqlite.org/index.html",children:"SQLite"})," format allows you to get benefits of a database, and at the same time the simplicity of storage of data in a file on a disk."]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["SQLite is the ",(0,s.jsx)(n.a,{href:"https://www.sqlite.org/mostdeployed.html",children:"most used"})," database engine in the world. SQLite is built into all mobile phones and most computers and comes bundled inside countless other applications that people use every day. The SQLite ",(0,s.jsx)(n.a,{href:"https://www.sqlite.org/fileformat2.html",children:"file format"})," is stable, cross-platform, and backwards compatible and the developers pledge to keep it that way through at least the year 2050."]}),"\n",(0,s.jsxs)(n.p,{children:["-- ",(0,s.jsx)(n.a,{href:"https://www.sqlite.org/index.html",children:"SQLite website"}),":"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"some-use-cases",children:"Some use-cases"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"You think you need MySQL, PostreSQL, etc for your ML project. Usually you don't"}),"\n",(0,s.jsx)(n.li,{children:"You have to deal with hundreds of GB of table-structured data (or larger) and your script (for whatever reason) can't be made parallel."}),"\n",(0,s.jsx)(n.li,{children:"You would request a lot of RAM and work with data slowly."}),"\n"]}),"\n",(0,s.jsx)(n.admonition,{type:"warning",children:(0,s.jsx)(n.p,{children:"This would be a waste of RAM."})}),"\n",(0,s.jsx)(n.admonition,{type:"tip",children:(0,s.jsx)(n.p,{children:"It is better in this case to request smaller amount of RAM and read data (efficiently) from disk - for example using SQLite"})}),"\n",(0,s.jsx)(n.h3,{id:"benefits",children:"Benefits:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"You are not limited by RAM any longer"}),"\n",(0,s.jsx)(n.li,{children:"Compared to other file formats SQLite is very good in selecting certain lines (especially if you use indexing)"}),"\n",(0,s.jsxs)(n.li,{children:["You can use familiar ",(0,s.jsx)(n.code,{children:"dplyr"})," syntax or execute SQL queries directly","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://dplyr.tidyverse.org/",children:"dplyr"})," is an interface for working with data in a database, not for modifying remote tables."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://dbi.r-dbi.org/",children:"DBI package"})," allows to both read and modify tables"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["SQLite is ",(0,s.jsx)(n.a,{href:"https://www.sqlite.org/speed.html",children:"actually faster for common data analysis tasks"})," than other popular databases."]}),"\n",(0,s.jsx)(n.li,{children:"You can have multiple threads accessing an SQLite database simultaneously (for read operations. Writing is more tricky)"}),"\n",(0,s.jsx)(n.li,{children:"Merging/Joining datasets on disk"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"major-benefits-of-sqlite-compared-to-mysql-postgresql-etc",children:"Major benefits of SQLite compared to MySQL (PostgreSQL, etc)"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"You control your own data (sqlite file). You don't depend on any service like MySQL"}),"\n",(0,s.jsx)(n.li,{children:"You can copy a file to your own laptop and work with it"}),"\n",(0,s.jsxs)(n.li,{children:["Again, ",(0,s.jsx)(n.a,{href:"https://www.sqlite.org/speed.html",children:"SQLite is faster"}),"!"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"limits",children:"Limits"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"SQLite has some limitations in terms of concurrency, which usually don't apply for typical ML/AI jobs."}),"\n",(0,s.jsxs)(n.li,{children:["See ",(0,s.jsx)(n.a,{href:"https://medium.com/@gwendal.roue/four-different-ways-to-handle-sqlite-concurrency-db3bcc74d00e",children:"Four Different Ways To Handle SQLite Concurrency"})," for more information."]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"command-line-cli-example",children:"Command line (CLI) example"}),"\n",(0,s.jsx)(n.p,{children:"Create environment"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"$ mkdir projects/sqlite-test\n$ cd projects/sqlite-test\n$ conda create -p ./cenv\n$ source activate ./cenv\n$ conda install -y sqlite\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Then ",(0,s.jsx)(n.a,{href:"https://sqlite.org/cli.html",children:"follow this SQLite example"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"$ sqlite3 db_file.sqlite\nsqlite> create table tbl1(one varchar(10), two smallint);\nsqlite> insert into tbl1 values('hello!', 10);\nsqlite> insert into tbl1 values('goodbye', 20);\nsqlite> select * from tbl1;\nhello!|10\ngoodbye|20\n"})}),"\n",(0,s.jsx)(n.p,{children:"Now Close session (Ctrl-D)."}),"\n",(0,s.jsx)(n.p,{children:"Reopen session to check if changes are saved"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"$ sqlite3 db_file.sqlite\nsqlite> select * from tbl1;\nhello!|10\ngoodbye|20\n"})}),"\n",(0,s.jsx)(n.h2,{id:"r-example",children:"R example"}),"\n",(0,s.jsx)(n.h3,{id:"install",children:"Install"}),"\n",(0,s.jsx)(n.p,{children:"Here we use conda, as a great way to keep everything isolated and reproducible."}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsx)(n.p,{children:"conda will install pre-compiled packages. Which is good (faster) and bad (not fully optimized for a specific hardware)"})}),"\n",(0,s.jsxs)(n.admonition,{type:"tip",children:[(0,s.jsxs)(n.p,{children:["Alternative: install packages to a local directory or use renv as described in ",(0,s.jsx)(n.a,{href:"/docs/hpc/tools_and_software/r_packages_with_renv",children:"R Packages with renv"})]}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"mkdir /scratch/$USER/projects/myTempProject\ncd  /scratch/$USER/projects/myTempProject\n\nmodule load anaconda3/2024.02\n\nconda create -p ./cenv -c conda-forge r=4.5\nsource activate ./cenv\nconda install -c r r-rsqlite\nconda install -c r r-tidyverse\nconda install -c conda-forge r-remotes\nconda install -c r r-feather\nconda install -c r r-nycflights13\n"})}),(0,s.jsxs)(n.admonition,{type:"note",children:[(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"https://github.com/r-dbi/RSQLite/issues/268",children:"window functions (row_number in particular) require newer version of rsqlite"})}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-R",children:'R\nremotes::install_github("r-dbi/RSQLite")\n## update ALL\n'})})]})]}),"\n",(0,s.jsxs)(n.admonition,{type:"tip",children:[(0,s.jsx)(n.p,{children:"Save list of installed packages for reproducibility"}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"## conda list --export > requirements.txt\n"})})]}),"\n",(0,s.jsx)(n.h3,{id:"use",children:"Use"}),"\n",(0,s.jsx)(n.p,{children:"Many examples can be found here:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://solutions.posit.co/connections/db/databases/sqlite/",children:"SQL syntax"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://solutions.posit.co/connections/db/r-packages/dplyr/",children:"dplyr syntax"})}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-R",children:'library(tidyverse)\nlibrary(DBI)\n# Create RSQLite database file with name "allData"\ncon <- dbConnect(RSQLite::SQLite(), "allData")\n'})}),"\n",(0,s.jsx)(n.p,{children:"Copy data frame to database (dplyr)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-R",children:'copy_to(con, nycflights13::flights, "fl", temporary=FALSE)\n'})}),"\n",(0,s.jsx)(n.p,{children:"Or copy data to database using DBI"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-R",children:'dbCreateTable(con, "fl", nycflights13::flights, temporary = FALSE)\ndbAppendTable(con, "fl", nycflights13::flights)\n'})}),"\n",(0,s.jsx)(n.p,{children:"Connect to a specific table"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-R",children:'dbListTables(con)\ndf_con <- tbl(con, "fl")\n## check number of rows\ndf_con %>% count()\n'})}),"\n",(0,s.jsx)(n.p,{children:"Subset"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-R",children:"df_temp <- df_con %>% filter( row_number() %in%  c(1, 3) ) %>% collect\n"})}),"\n",(0,s.jsx)(n.p,{children:"Save as feather"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-R",children:'feather::write_feather(df_temp, "my_data.feather")\n'})}),"\n",(0,s.jsx)(n.h3,{id:"alternative-read-csv-file-to-sqlite-directly",children:"Alternative: read csv file to SQLite directly"}),"\n",(0,s.jsx)(n.p,{children:"If you already have a large csv file on disk, and you don't want to read it to RAM, you can read it to SQLite file directly"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-R",children:'conda install -c conda-forge r-sqldf \nR\nlibrary(sqldf)\n## create data file\n# sqldf("attach allData as new")\n\n# make csv file for this example\nwrite.csv(df_con, "df_con.csv", row.names = FALSE)\n\n# read file directly from csv to sqlite\nread.csv.sql(file = "df_con.csv", sql = "create table states_data as select * from file", dbname = "allData")\n\n# verify data in data frame\ndbListTables(con)\n[1] "fl"           "sqlite_stat1" "sqlite_stat4" "states_data" \n\ndf_con_sd <- tbl(con, "states_data")\ndf_con_sd\n# Source:   table<`states_data`> [?? x 19]\n# Database: sqlite 3.50.1 [/scratch/netID/myTempProject/allData]\n    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time\n   <int> <int> <int>    <int>          <int>     <int>    <int>          <int>\n 1  2013     1     1      517            515         2      830            819\n 2  2013     1     1      533            529         4      850            830\n 3  2013     1     1      542            540         2      923            850\n 4  2013     1     1      544            545        -1     1004           1022\n 5  2013     1     1      554            600        -6      812            837\n 6  2013     1     1      554            558        -4      740            728\n 7  2013     1     1      555            600        -5      913            854\n 8  2013     1     1      557            600        -3      709            723\n 9  2013     1     1      557            600        -3      838            846\n10  2013     1     1      558            600        -2      753            745\n# \u2139 more rows\n# \u2139 11 more variables: arr_delay <int>, carrier <chr>, flight <int>,\n#   tailnum <chr>, origin <chr>, dest <chr>, air_time <int>, distance <int>,\n#   hour <int>, minute <int>, time_hour <int>\n# \u2139 Use `print(n = ...)` to see more rows\n'})}),"\n",(0,s.jsx)(n.h2,{id:"ui-for-sqlite---sqlitestudio",children:"UI for SQLite - SQLiteStudio"}),"\n",(0,s.jsxs)(n.p,{children:["Once you have SQLite file, you can easily transfer it to your own laptop and explore it using ",(0,s.jsx)(n.a,{href:"https://sqlitestudio.pl/",children:"SQLiteStudio"}),", if you like to use UI instead of terminal"]})]})}function h(e={}){let{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},30416(e,n,t){t.d(n,{R:()=>l,x:()=>r});var i=t(59471);let s={},a=i.createContext(s);function l(e){let n=i.useContext(a);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),i.createElement(a.Provider,{value:n},e.children)}}}]);